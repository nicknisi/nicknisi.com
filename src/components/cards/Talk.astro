---
import { type CollectionEntry, getEntry } from 'astro:content';
import { getThumbnail } from '@/utils/image.js';
import { Image } from 'astro:assets';
import Card from '@/components/Card.astro';
import type { ImageMetadata } from 'astro';

type Talk = CollectionEntry<'talks'>['data'];

interface Props {
	id: CollectionEntry<'talks'>['id'];
}

const { id } = Astro.props;
const talk = await getEntry('talks', id);
const { type, title, detailsUrl, instances } = talk.data;
const thumbnail = await getThumbnail(talk.data);
const hasMultipleInstances = instances.length > 1;
const firstInstance = instances[0]!;
---

<Card class="bg-white dark:bg-gray-900">
	<div class="p-3">
		<div class="group relative">
			<Image
				src={thumbnail as ImageMetadata}
				alt={title}
				width={240}
				height={135}
				class="aspect-video w-full rounded object-cover"
			/>
			{
				hasMultipleInstances ? (
					<a
						href={detailsUrl}
						class="absolute inset-0 flex items-center justify-center bg-dark-obsidian/0 transition-all duration-200 group-hover:bg-dark-obsidian/30"
						title="View all instances of this talk"
					>
						<span class="rounded-full bg-dark-obsidian/50 px-3 py-1 text-sm text-white opacity-0 transition-opacity duration-200 group-hover:opacity-100">
							View All
						</span>
					</a>
				) : (
					instances[0] && (
						<a
							href={firstInstance.url}
							class="absolute inset-0 flex items-center justify-center bg-dark-obsidian/0 transition-all duration-200 group-hover:bg-dark-obsidian/30"
							target="_blank"
							rel="noopener noreferrer"
						>
							<span class="rounded-full bg-dark-obsidian/50 px-3 py-1 text-sm text-white opacity-0 transition-opacity duration-200 group-hover:opacity-100">
								Watch Video
							</span>
						</a>
					)
				)
			}
		</div>

		<div class="mt-3">
			<div class="mb-2">
				<span class="text-blue-600 dark:text-blue-300 text-xs font-medium">
					{type}
				</span>
			</div>

			<h3 class="mb-2 line-clamp-2 text-base font-medium">
				{title}
			</h3>

			{
				hasMultipleInstances ? (
					<div class="space-y-1">
						<div class="flex items-center justify-between text-xs text-gray-600 dark:text-gray-400">
							<span>{instances.length} presentations</span>
							<a href={detailsUrl} class="text-blue-600 dark:text-blue-300 hover:underline">
								View all â†’
							</a>
						</div>
					</div>
				) : (
					<div class="space-y-1 text-xs text-gray-600 dark:text-gray-400">
						<div>{firstInstance.event}</div>
						<div class="flex gap-1">
							<div>{firstInstance.location}</div>

							<div>{firstInstance.date}</div>
						</div>
					</div>
				)
			}
		</div>
	</div>
</Card>
